<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enterprise Terminal v4.5 - CNBC-e Professional</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --cnbc-green: #008f39; --cnbc-red: #c40000; --cnbc-blue: #003366;
            --cnbc-light-blue: #004a99; --gold-color: #ffd700;
        }

        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; color: #fff; font-family: 'Inter', sans-serif; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #engine-container { position: relative; width: 100%; height: 100%; z-index: 2; }

        .grid-custom { display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: 1.5fr 1fr 1fr; gap: 1.5vh; height: 97vh; width: 97vw; margin: auto; }
        
        #mod3-container { display: none; width: 100%; height: 100%; position: relative; }
        .video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .video-wrapper video { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.7); }
        
        .branding-panel { position: absolute; bottom: 135px; left: 0; background: #fff; padding: 5px 20px; border-radius: 0 4px 0 0; display: flex; align-items: center; gap: 15px; z-index: 110; }
        .cnbc-clock { font-size: 1.4vw; font-weight: 900; color: #003366; font-family: 'JetBrains Mono'; border-left: 2px solid #ddd; padding-left: 15px; }

        .ticker-container { position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column; z-index: 100; }
        
        /* 1. Üst Ticker - Hızlandırıldı */
        .layer-indices { height: 40px; background: #fff; display: flex; align-items: center; position: relative; overflow: hidden; }
        .bist-box { background: var(--cnbc-green); color: #fff; padding: 0 25px; height: 100%; display: flex; align-items: center; gap: 10px; font-weight: 900; font-size: 1.2vw; position: relative; z-index: 130; box-shadow: 20px 0 25px rgba(0,0,0,0.5); }
        .index-track-wrapper { flex: 1; overflow: hidden; position: relative; z-index: 120; }
        .index-track { display: flex; white-space: nowrap; animation: scroll-ticker 48s linear infinite; color: #003366; } /* %25 Hızlandı: 65s -> 48s */
        .index-item { padding: 0 30px; display: flex; align-items: center; gap: 8px; font-size: 0.95vw; font-weight: 800; }

        /* 2. Orta Ticker - 4 Kart ve Parlama Efekti */
        .layer-currencies { height: 60px; background: var(--cnbc-blue); display: flex; align-items: center; overflow: hidden; border-top: 1px solid rgba(255,255,255,0.1); }
        .cur-card { 
            flex: 0 0 25%; min-width: 25%; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 0 20px; 
            border-right: 1px solid rgba(255,255,255,0.1); transition: background 0.5s ease, box-shadow 0.3s ease; position: relative; box-sizing: border-box;
        }
        .cur-name { font-size: 0.75rem; color: #a5c7ff; font-weight: 700; margin-bottom: 2px; }
        .cur-value-box { height: 30px; overflow: hidden; position: relative; }
        .cur-price-container { display: flex; flex-direction: column; transition: transform 0.6s cubic-bezier(0.65, 0, 0.35, 1); }
        .cur-price { height: 30px; line-height: 30px; font-size: 1.5rem; color: #fff; font-family: 'JetBrains Mono'; font-weight: 800; }
        
        /* Parlama (Flash) Efekti Sınıfı */
        .card-flash { animation: flash-glow 0.8s ease-out; }
        @keyframes flash-glow {
            0% { filter: brightness(1); }
            50% { filter: brightness(2); box-shadow: inset 0 0 20px #fff; }
            100% { filter: brightness(1); }
        }

        /* 3. Alt Ticker - Hızlandırıldı */
        .layer-news { height: 35px; background: #fff; display: flex; align-items: center; color: #003366; font-weight: 700; font-size: 0.9vw; position: relative; overflow: hidden; }
        .news-label { background: var(--cnbc-light-blue); color: #fff; padding: 0 20px; height: 100%; display: flex; align-items: center; z-index: 130; position: relative; box-shadow: 10px 0 15px rgba(0,0,0,0.2); }
        .news-track-wrapper { flex: 1; overflow: hidden; z-index: 120; }
        .news-track { display: flex; white-space: nowrap; animation: scroll-ticker 45s linear infinite; } /* %25 Hızlandı: 60s -> 45s */

        @keyframes scroll-ticker { from { transform: translateX(0); } to { transform: translateX(-50%); } }
        .slide-up { transform: translateY(-30px); }
    </style>
</head>
<body>

<div id="engine-container"></div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCfcppc4rGYxmAj7fTzmYMZgcyBO4s8bFI",
      databaseURL: "https://doviz-kurlari-35554-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "doviz-kurlari-35554",
      appId: "1:822410580056:web:40d02d7729d7cf72aafa2d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let state = { mode: null };

    db.ref('terminal_data/tv_settings').on('value', snap => {
        const s = snap.val();
        const newMode = s.master2 ? s.screen2.toString() : "0";
        if (state.mode !== newMode) { state.mode = newMode; initMode(newMode); }
    });

    function initMode(mode) {
        const container = document.getElementById('engine-container');
        db.ref('terminal_data/currencies').off();
        container.innerHTML = "";
        if (mode === "3" || mode === "6") {
            renderCNBCLayout(container);
            db.ref('terminal_data/currencies').on('value', snap => updateCNBCData(snap.val()));
        }
    }

    function renderCNBCLayout(container) {
        container.innerHTML = `
            <div id="mod3-container" style="display:block">
                <div class="video-wrapper"><video autoplay muted loop playsinline><source src="videocnbce.mp4" type="video/mp4"></video></div>
                <div class="branding-panel">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/CNBC_logo.svg/1200px-CNBC_logo.svg.png" style="height:32px">
                    <div class="cnbc-clock" id="cnbcClock">00:00</div>
                </div>
                <div class="ticker-container">
                    <div class="layer-indices">
                        <div class="bist-box">BIST100 <span>12.793,10</span> <i class="fas fa-caret-down"></i></div>
                        <div class="index-track-wrapper"><div class="index-track" id="indicesTrack"></div></div>
                    </div>
                    <div class="layer-currencies" id="cnbcCurrencies"></div>
                    <div class="layer-news">
                        <div class="news-label">HABER</div>
                        <div class="news-track-wrapper"><div class="news-track" id="newsTrack">YÜKLENİYOR...</div></div>
                    </div>
                </div>
            </div>`;
        
        setInterval(() => {
            document.getElementById('cnbcClock').innerText = new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
        }, 1000);

        // Alım-Satım Kaydırma ve Renk/Parlama Döngüsü
        setInterval(() => {
            document.querySelectorAll('.cur-price-container').forEach(el => el.classList.toggle('slide-up'));
            applyFlashAndColors();
        }, 3000);

        fetchRSS();
    }

    function updateCNBCData(data) {
        const track = document.getElementById('cnbcCurrencies');
        if(!track || !data) return;
        // Firebase verilerini al (limit koymadan hepsini render edebiliriz ama ekran 4 tane gösterir)
        const currencies = Object.values(data);
        track.innerHTML = currencies.map(item => `
            <div class="cur-card" id="card-${item.name.replace(/\s/g, '')}">
                <span class="cur-name">${item.name}</span>
                <div class="cur-value-box">
                    <div class="cur-price-container">
                        <span class="cur-price">${item.sell.toLocaleString('tr-TR', {minimumFractionDigits:4})}</span>
                        <span class="cur-price">${item.buy.toLocaleString('tr-TR', {minimumFractionDigits:4})}</span>
                    </div>
                </div>
            </div>`).join('');
    }

    function applyFlashAndColors() {
        document.querySelectorAll('.cur-card').forEach(card => {
            // Parlama efekti ekle
            card.classList.remove('card-flash');
            void card.offsetWidth; // Reflow
            card.classList.add('card-flash');

            // Renk değişimi
            const rand = Math.random();
            if (rand > 0.7) card.style.background = 'rgba(0, 143, 57, 0.9)'; 
            else if (rand > 0.4) card.style.background = 'rgba(196, 0, 0, 0.9)'; 
            else card.style.background = '#003366';
        });
    }

    async function fetchRSS() {
        try {
            const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.aa.com.tr/tr/rss/default?cat=ekonomi');
            const data = await res.json();
            const track = document.getElementById('newsTrack');
            if(track && data.status === 'ok') {
                const html = data.items.map(i => `<span style="margin-right:60px">${i.title.toUpperCase()} • </span>`).join('');
                track.innerHTML = html + html;
            }
            const iTrack = document.getElementById('indicesTrack');
            const indices = ["NASDAQ 18.240,40 %0,45 ▲", "DAX 17.120,10 %0,12 ▼", "DOW JONES 39.120 %0,05 ▲", "FTSE 100 7.820 %0,22 ▼"];
            iTrack.innerHTML = indices.map(n => `<div class="index-item">${n}</div>`).join('') + indices.map(n => `<div class="index-item">${n}</div>`).join('');
        } catch(e) {}
    }
</script>
</body>
</html>
