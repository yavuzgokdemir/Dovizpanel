<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PaNeLX Finans - Ultra Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --bg: #0b1220; 
            --card: #131b2b; 
            --text: #e7eef7; 
            --muted: #94a3b8; 
            --buy: #22c55e; 
            --sell: #ef4444; 
            --accent: #f59e0b; 
            --header-bg: #101827;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
            transition: all 0.3s ease; 
        }

        .dark-mode { 
            background-color: var(--bg) !important; 
            color: var(--text) !important; 
        }
        .dark-mode .bg-white { 
            background-color: var(--card) !important; 
            border-color: rgba(255,255,255,0.05) !important; 
            color: var(--text) !important;
        }
        .dark-mode .bg-slate-50, .dark-mode .bg-indigo-50, .dark-mode .bg-emerald-50, .dark-mode .bg-rose-50, .dark-mode .bg-orange-50 { 
            background-color: rgba(255,255,255,0.03) !important; 
        }
        .dark-mode .text-slate-900, .dark-mode .text-indigo-900, .dark-mode .text-slate-500, .dark-mode .text-slate-400 { 
            color: var(--text) !important; 
        }
        .dark-mode .sticky-summary { 
            background: var(--card) !important; 
            border-top: 1px solid rgba(255,255,255,0.1); 
        }
        .dark-mode header {
            background-color: var(--header-bg) !important;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .dark-mode #pos-modal .bg-white, .dark-mode #note-modal .bg-white, .dark-mode #auth-modal .bg-white { background-color: var(--card) !important; }
        .dark-mode #pos-modal button.bg-slate-100, .dark-mode #auth-modal button.bg-slate-100 { background-color: rgba(255,255,255,0.1) !important; color: white !important; }
        .dark-mode #pos-display, .dark-mode #auth-display { background-color: rgba(0,0,0,0.3) !important; border-color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .compact-input { background: transparent; border: none; outline: none; width: 100%; font-size: 13px; font-weight: 700; color: inherit; }
        .sticky-summary { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; z-index: 100; height: 80px; }
        
        .nav-active { color: var(--accent) !important; }
        .nav-active .nav-icon::after { content: ''; position: absolute; top: -12px; width: 25px; height: 3px; background: var(--accent); border-radius: 10px; }
        
        .badge { font-size: 9px; padding: 4px 8px; border-radius: 8px; font-weight: 800; text-transform: uppercase; }
        #pos-modal, #note-modal, #auth-modal { display: none; position: fixed; inset: 0; background: rgba(11, 18, 32, 0.9); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        
        select { border: 1px solid rgba(0,0,0,0.1); background: #f1f5f9; font-weight: 700; font-size: 11px; padding: 6px 10px; border-radius: 10px; outline: none; }
        .dark-mode select { background: var(--bg) !important; color: var(--text) !important; border-color: rgba(255,255,255,0.1) !important; }
        .dark-mode input, .dark-mode textarea { background-color: rgba(255,255,255,0.05) !important; color: white !important; border-color: rgba(255,255,255,0.1) !important; }
        
        .btn-primary { background: var(--accent); color: #000; font-weight: 800; transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.95); }

        .logo-box {
            background: var(--card);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        @keyframes pulse-x {
            0%, 100% { opacity: 1; color: var(--accent); }
            50% { opacity: 0.5; color: var(--sell); }
        }
        .connected-x { animation: pulse-x 1.5s infinite; }

        .segmented-bar-container { height: 12px; border-radius: 6px; overflow: hidden; display: flex; background: rgba(0,0,0,0.05); }
        .dark-mode .segmented-bar-container { background: rgba(255,255,255,0.05); }

        .readonly-overlay {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            font-size: 10px;
            font-weight: 900;
            padding: 4px;
            z-index: 40;
            display: none;
            letter-spacing: 1px;
        }

        .history-line { border-left: 2px solid var(--accent); padding-left: 10px; margin-bottom: 10px; position: relative; }
        .history-line::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; }

        .excel-table { border-collapse: collapse; width: 100%; font-size: 10px; }
        .excel-table th { background: #f1f5f9; color: #475569; padding: 8px; border: 1px solid #e2e8f0; text-transform: uppercase; }
        .excel-table td { padding: 8px; border: 1px solid #e2e8f0; font-weight: 700; }
        .dark-mode .excel-table th { background: #1e293b; color: #94a3b8; border-color: #334155; }
        .dark-mode .excel-table td { border-color: #334155; }

        /* YENÄ° USD ANÄ°MASYONU VE RENK DEÄÄ°ÅÄ°MÄ° */
        @keyframes usd-flow {
            0% { color: #22c55e; }
            50% { color: #f59e0b; }
            100% { color: #22c55e; }
        }
        .usd-badge {
            font-size: 9px;
            font-weight: 800;
            display: block;
            animation: usd-flow 3s infinite ease-in-out;
            opacity: 0.8;
        }
    </style>
</head>
<body class="pb-28">

    <div id="auth-modal">
        <div class="bg-white p-6 rounded-[2rem] w-80 space-y-4 shadow-2xl border border-slate-100 text-center">
            <h2 class="text-xs font-black uppercase text-amber-500 tracking-[0.2em]">SÄ°STEM GÃœVENLÄ°ÄÄ°</h2>
            <div id="auth-display" class="bg-slate-50 p-6 rounded-2xl text-center text-4xl font-extrabold text-slate-800 border border-slate-100 tracking-[0.3em]">****</div>
            <div class="grid grid-cols-3 gap-3">
                <script>
                    for(let i=1; i<=9; i++) document.write(`<button onclick="authPress(${i})" class="bg-slate-100 p-4 rounded-2xl font-bold text-xl active:scale-95 transition-transform">${i}</button>`);
                </script>
                <div class="p-4"></div>
                <button onclick="authPress(0)" class="bg-slate-100 p-4 rounded-2xl font-bold text-xl">0</button>
                <button onclick="authClear()" class="bg-rose-100 text-rose-600 p-4 rounded-2xl font-bold text-xl">C</button>
            </div>
            <p class="text-[9px] text-slate-400 font-bold uppercase">LÃœTFEN 4 HANELÄ° PIN GÄ°RÄ°NÄ°Z</p>
        </div>
    </div>

    <div id="readonly-banner" class="readonly-overlay uppercase">âš ï¸ ArÅŸiv Ä°zleme Modu: DeÄŸiÅŸiklikler Kaydedilmez</div>

    <div id="pos-modal">
        <div class="bg-white p-6 rounded-[2rem] w-80 space-y-4 shadow-2xl border border-slate-100">
            <div id="pos-display" class="bg-slate-50 p-6 rounded-2xl text-right text-4xl font-extrabold text-amber-500 border border-amber-100">0</div>
            <div class="grid grid-cols-3 gap-3">
                <script>
                    for(let i=1; i<=9; i++) document.write(`<button onclick="posPress(${i})" class="bg-slate-100 p-4 rounded-2xl font-bold text-xl active:scale-95 transition-transform">${i}</button>`);
                </script>
                <button onclick="posPress('.')" class="bg-slate-100 p-4 rounded-2xl font-bold text-xl">.</button>
                <button onclick="posPress(0)" class="bg-slate-100 p-4 rounded-2xl font-bold text-xl">0</button>
                <button onclick="posClear()" class="bg-rose-100 text-rose-600 p-4 rounded-2xl font-bold text-xl">C</button>
            </div>
            <button onclick="posConfirm()" class="w-full btn-primary py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg">GÄ°RÄ°ÅÄ° ONAYLA</button>
        </div>
    </div>

    <div id="note-modal">
        <div class="bg-white p-6 rounded-[2rem] w-[90%] max-w-md space-y-4 shadow-2xl border border-slate-100 overflow-hidden flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center">
                <h3 class="text-sm font-black uppercase tracking-widest text-amber-500">Ä°ÅŸlem DetayÄ± & GeÃ§miÅŸ</h3>
                <button onclick="closeNoteModal()" class="text-slate-400 font-bold text-xl">âœ•</button>
            </div>
            <textarea id="note-input" rows="3" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xs outline-none border border-transparent focus:border-amber-500" placeholder="AÃ§Ä±klama veya not girin..."></textarea>
            <button onclick="saveNote()" class="btn-primary py-3 rounded-xl font-black text-[10px] uppercase tracking-widest">AÃ‡IKLAMAYI KAYDET</button>
            <div class="border-t pt-4 flex-1 overflow-y-auto custom-scrollbar">
                <p class="text-[9px] font-black text-slate-400 uppercase mb-3 tracking-widest">ğŸ“œ Hareket GeÃ§miÅŸi</p>
                <div id="history-container" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <header class="bg-white/90 border-b border-slate-100 px-4 py-4 sticky top-0 z-50 shadow-sm backdrop-blur-md">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="logo-box w-10 h-10 rounded-xl flex items-center justify-center text-lg font-black italic shadow-inner">ğŸ¦</div>
                <div id="top-status-card" class="bg-slate-900 text-white px-4 py-2 rounded-2xl border border-slate-700 min-w-[150px]">
                    <span id="bar-label" class="text-[8px] font-extrabold text-amber-500 uppercase block leading-none mb-1 tracking-widest">SÄ°STEM AKTÄ°F</span>
                    <span id="net-val" class="text-xs font-black leading-none block">â‚º0,00</span>
                    <span id="net-val-usd" class="usd-badge mt-1">$0.00</span>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <button onclick="toggleDarkMode()" class="text-xl">ğŸŒ“</button>
                <button onclick="exportData()" class="bg-slate-100 dark:bg-slate-800 p-2.5 rounded-xl text-lg">ğŸ“¥</button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-5">
        
        <div id="kasa-tab" class="tab-content active">
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="bg-slate-50/50 px-6 py-4 border-b flex justify-between items-center">
                    <span class="text-[11px] font-black uppercase text-slate-500 tracking-wider">ğŸ“‹ Kasa YÃ¶netimi</span>
                    <button id="add-kasa-btn" onclick="addRow('kasa')" class="btn-primary w-8 h-8 rounded-xl font-bold text-xl">+</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-[11px] font-bold">
                        <thead class="bg-slate-50/30 text-slate-400">
                            <tr>
                                <th class="p-3 text-left uppercase">Kur</th>
                                <th class="p-3 text-right uppercase">V1</th>
                                <th class="p-3 text-right uppercase">V2</th>
                                <th class="p-3 text-right uppercase">Ana</th>
                                <th class="p-3 text-right uppercase text-amber-500">Toplam</th>
                                <th class="p-3"></th>
                            </tr>
                        </thead>
                        <tbody id="kasa-body" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="cari-tab" class="tab-content space-y-4">
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="bg-emerald-50/50 px-6 py-4 border-b flex justify-between items-center text-emerald-600 font-black text-[11px] tracking-wider">
                    <span>ğŸ“ˆ ALACAKLAR</span><button id="add-alacak-btn" onclick="addRow('alacak')" class="font-bold text-xl">+</button>
                </div>
                <table class="w-full text-xs font-bold"><tbody id="alacak-body" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody></table>
            </div>
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="bg-rose-50/50 px-6 py-4 border-b flex justify-between items-center text-rose-600 font-black text-[11px] tracking-wider">
                    <span>ğŸ“‰ BORÃ‡LAR</span><button id="add-borc-btn" onclick="addRow('borc')" class="font-bold text-xl">+</button>
                </div>
                <table class="w-full text-xs font-bold"><tbody id="borc-body" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody></table>
            </div>
            
            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-lg">ğŸ‘¤</span>
                    <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">KiÅŸi Ekstresi</h3>
                </div>
                <select id="ekstre-select" onchange="renderEkstre()" class="w-full mb-5 bg-slate-50 p-4 rounded-2xl font-bold text-xs border border-slate-100 shadow-inner"></select>
                
                <div id="ekstre-sonuc" class="hidden space-y-4 animate-fadeIn">
                    <div class="bg-slate-50 dark:bg-white/5 rounded-2xl p-4 border border-slate-100 dark:border-white/10">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Ä°ÅŸlem Hareketleri</span>
                            <span class="text-[8px] px-2 py-1 bg-amber-500/10 text-amber-600 rounded-lg font-bold">ANLIK VERÄ°</span>
                        </div>
                        <div class="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar" id="ekstre-detay-body">
                            </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-emerald-500/5 rounded-2xl border border-emerald-500/10">
                            <span class="text-[8px] font-black text-emerald-500 uppercase block mb-1">Toplam Alacak</span>
                            <span id="ekstre-alacak" class="text-sm font-black text-emerald-600">â‚º0,00</span>
                        </div>
                        <div class="p-4 bg-rose-500/5 rounded-2xl border border-rose-500/10">
                            <span class="text-[8px] font-black text-rose-500 uppercase block mb-1">Toplam BorÃ§</span>
                            <span id="ekstre-borc" class="text-sm font-black text-rose-600">â‚º0,00</span>
                        </div>
                    </div>

                    <div id="ekstre-net-bg" class="relative overflow-hidden p-6 rounded-[2rem] shadow-xl transition-all duration-500">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-12 -mt-12 blur-2xl"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <span class="text-[10px] font-black text-white/70 uppercase tracking-widest block mb-1">GÃœNCEL NET DURUM</span>
                                <span id="ekstre-net" class="text-2xl font-black text-white block leading-none">â‚º0,00</span>
                                <span id="ekstre-net-usd" class="text-[10px] font-bold text-white/80 mt-1 block tracking-wider">$0.00</span>
                            </div>
                            <div id="ekstre-icon" class="text-4xl">ğŸ’</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="gider-tab" class="tab-content">
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="bg-amber-50/50 px-6 py-4 border-b flex justify-between items-center text-amber-600 font-black text-[11px] tracking-wider">
                    <span>ğŸ’¸ GÄ°DERLER</span><button id="add-gider-btn" onclick="addRow('gider')" class="font-bold text-xl">+</button>
                </div>
                <table class="w-full text-xs font-bold"><tbody id="gider-body" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody></table>
            </div>
        </div>

        <div id="analiz-tab" class="tab-content space-y-5">
            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6 text-center">ğŸ“Š Finansal Analiz & Risk</h3>
                
                <div class="mb-8 space-y-3">
                    <div class="flex justify-between items-end">
                        <div>
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest block">SÄ°STEM SKORU</span>
                            <span id="risk-status" class="text-[10px] font-bold uppercase tracking-tighter">HESAPLANIYOR...</span>
                        </div>
                        <span id="risk-percent" class="text-2xl font-black text-amber-500">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 dark:bg-white/5 h-4 rounded-full overflow-hidden flex border border-slate-200 dark:border-white/5 shadow-inner">
                        <div id="risk-bar" class="h-full transition-all duration-1000 shadow-[0_0_15px_rgba(245,158,11,0.5)]" style="width: 0%; background: var(--accent);"></div>
                    </div>
                    <p class="text-[8px] text-slate-400 italic text-center">Skor AlgoritmasÄ±: (Nakit + Alacak) / (BorÃ§ + Gider) katsayÄ±sÄ±na dayanÄ±r.</p>
                </div>

                <div class="grid grid-cols-1 gap-6 mb-8">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center"><p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">VarlÄ±k DaÄŸÄ±lÄ±mÄ±</p></div>
                        <div id="fin-segmented-bar" class="segmented-bar-container h-4 shadow-sm"></div>
                        <div id="fin-legend" class="flex flex-wrap gap-x-4 gap-y-2 justify-center"></div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center"><p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">DÃ¶viz YoÄŸunluÄŸu (Kasa)</p></div>
                        <div id="curr-segmented-bar" class="segmented-bar-container h-4 shadow-sm"></div>
                        <div id="curr-legend" class="flex flex-wrap gap-x-4 gap-y-2 justify-center"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-slate-900 p-4 rounded-3xl border border-slate-700 shadow-lg">
                        <span class="text-[8px] font-black text-amber-500 uppercase block mb-1">ğŸ’° Nakit</span>
                        <span id="sum-kasa" class="text-base font-black text-white">â‚º0,00</span>
                        <span id="sum-kasa-usd" class="usd-badge">$0.00</span>
                    </div>
                    <div class="bg-emerald-900/10 p-4 rounded-3xl border border-emerald-500/20 shadow-sm">
                        <span class="text-[8px] font-black text-emerald-500 uppercase block mb-1">ğŸ“ˆ Alacak</span>
                        <span id="sum-alacak-analiz" class="text-base font-black text-emerald-600 dark:text-emerald-400">â‚º0,00</span>
                        <span id="sum-alacak-usd" class="usd-badge">$0.00</span>
                    </div>
                    <div class="bg-rose-900/10 p-4 rounded-3xl border border-rose-500/20 shadow-sm">
                        <span class="text-[8px] font-black text-rose-500 uppercase block mb-1">ğŸ“‰ BorÃ§</span>
                        <span id="sum-borc-analiz" class="text-base font-black text-rose-600 dark:text-rose-400">â‚º0,00</span>
                        <span id="sum-borc-usd" class="usd-badge">$0.00</span>
                    </div>
                    <div class="bg-slate-100 dark:bg-white/5 p-4 rounded-3xl border border-slate-200 dark:border-white/5 shadow-sm">
                        <span class="text-[8px] font-black text-slate-500 uppercase block mb-1">ğŸ’¸ Gider</span>
                        <span id="sum-gider-analiz" class="text-base font-black text-slate-600 dark:text-slate-300">â‚º0,00</span>
                        <span id="sum-gider-usd" class="usd-badge">$0.00</span>
                    </div>
                </div>

                <div id="net-kazanc-bg" class="bg-slate-900 p-6 rounded-[2.5rem] border border-amber-500/30 flex justify-between items-center shadow-2xl relative overflow-hidden mb-8">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/5 rounded-full blur-3xl -mr-16 -mt-16"></div>
                    <div class="relative z-10">
                        <span class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-1 block">ğŸ† NET PORTFÃ–Y</span>
                        <span id="sum-net-kazanc" class="text-2xl font-black text-white block">â‚º0,00</span>
                        <span id="sum-net-usd" class="usd-badge">$0.00</span>
                    </div>
                    <div class="text-4xl connected-x relative z-10">ğŸ¦</div>
                </div>

                <div class="bg-indigo-900/10 p-5 rounded-[2rem] border border-indigo-500/20">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">â˜ï¸ Cloud Snapshots</h4>
                        <button onclick="takeCloudSnapshot()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-xl text-[8px] font-black hover:bg-indigo-500 transition shadow-md">ANLIK GÃ–RÃœNTÃœ AL</button>
                    </div>
                    <div id="cloud-snapshot-list" class="space-y-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                        <div class="text-[9px] text-slate-400 italic text-center py-4">Firebase baÄŸlantÄ±sÄ± kurulmaya hazÄ±r.</div>
                    </div>
                </div>

            </div>
        </div>

        <div id="gecmis-tab" class="tab-content space-y-5">
            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-6">ğŸ—“ï¸ Ay Sonu KasasÄ± & GeÃ§miÅŸ</h3>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="setDateRange('thisMonth')" class="bg-indigo-500 text-white py-2 rounded-xl font-black text-[9px] uppercase tracking-wider shadow-md active:scale-95 transition">BU AY</button>
                    <button onclick="setDateRange('lastMonth')" class="bg-slate-600 text-white py-2 rounded-xl font-black text-[9px] uppercase tracking-wider shadow-md active:scale-95 transition">GEÃ‡EN AY</button>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div>
                        <label class="text-[8px] font-black text-slate-400 uppercase block mb-1 ml-2">BaÅŸlangÄ±Ã§</label>
                        <input type="date" id="history-start" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl font-bold text-xs border-none outline-none">
                    </div>
                    <div>
                        <label class="text-[8px] font-black text-slate-400 uppercase block mb-1 ml-2">BitiÅŸ</label>
                        <input type="date" id="history-end" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl font-bold text-xs border-none outline-none">
                    </div>
                </div>

                <button onclick="renderHistoryTable()" class="w-full btn-primary py-3 rounded-xl font-black text-[10px] uppercase mb-6 tracking-widest">SORGULA & LÄ°STELE</button>

                <div class="overflow-x-auto border rounded-xl dark:border-white/10">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th class="text-right">Kasa Net</th>
                                <th class="text-right">FiÅŸ Adedi</th>
                                <th class="text-right">Net Kar (GÃ¼nlÃ¼k)</th>
                                <th>Gider AÃ§Ä±klama</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="dark:text-white">
                            <tr><td colspan="5" class="text-center py-10 text-slate-400 italic">Verileri gÃ¶rmek iÃ§in tarih seÃ§ip sorgulayÄ±n.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content space-y-5">
            <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                <h3 class="text-[11px] font-black text-slate-400 mb-4 uppercase tracking-widest">ğŸ’¾ KayÄ±t & ArÅŸiv YÃ¶netimi</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="backupMonth()" class="bg-emerald-600 text-white py-4 rounded-2xl font-black text-[10px] shadow-lg active:scale-95 transition tracking-widest">DOSYAYI KAYDET</button>
                    <div class="relative">
                        <input type="file" id="importFile" onchange="loadArchive(event)" class="hidden">
                        <button onclick="document.getElementById('importFile').click()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-[10px] shadow-lg active:scale-95 transition tracking-widest">DOSYA AÃ‡</button>
                    </div>
                </div>

                <div id="archive-panel" class="hidden space-y-4 bg-slate-50 dark:bg-white/5 p-4 rounded-[1.5rem] border border-dashed border-slate-300 dark:border-white/10">
                    <div class="flex justify-between items-center">
                        <span id="archive-info" class="text-[9px] font-black text-amber-500 uppercase"></span>
                        <button onclick="exitArchiveMode()" class="text-[8px] font-black bg-rose-500 text-white px-2 py-1 rounded-lg">Ä°ZLEMEDEN Ã‡IK</button>
                    </div>
                    <select id="archive-days-select" onchange="loadDayFromArchive()" class="w-full bg-white dark:bg-slate-900 border-none"></select>
                    
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-widest">ğŸ“Š Ay Ä°Ã§i KarÅŸÄ±laÅŸtÄ±rma</p>
                        <div id="comparison-list" class="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                <h3 class="text-[11px] font-black text-slate-400 mb-4 uppercase tracking-widest">ğŸ’ VarlÄ±k & Birim YÃ¶netimi</h3>
                
                <div class="space-y-4 mb-6 bg-slate-50 dark:bg-white/5 p-4 rounded-3xl border border-slate-100 dark:border-white/5">
                    <div class="flex gap-2">
                        <input id="new-cat-name" type="text" placeholder="Kategori (Ã¶rn: AltÄ±n)" class="flex-1 p-3 bg-white dark:bg-slate-800 rounded-xl font-bold text-xs uppercase outline-none border border-slate-200 focus:border-amber-500">
                        <button onclick="addCategory()" class="btn-primary px-4 rounded-xl font-bold text-[10px]">EKLE</button>
                    </div>
                    <div class="flex gap-2">
                        <select id="cat-select-for-unit" class="flex-1 bg-white dark:bg-slate-800"></select>
                        <input id="new-unit-code" type="text" placeholder="Birim (Ã¶rn: Ata)" class="w-24 p-3 bg-white dark:bg-slate-800 rounded-xl font-bold text-xs uppercase outline-none border border-slate-200 focus:border-amber-500">
                        <button onclick="addUnitToCategory()" class="btn-primary px-4 rounded-xl font-bold text-[10px]">BÄ°RÄ°M EKLE</button>
                    </div>
                </div>

                <div id="rate-management-list" class="space-y-6"></div>
            </div>

            <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                <h3 class="text-[11px] font-black text-slate-400 mb-4 uppercase tracking-widest">ğŸ’¸ Gider Kategorileri</h3>
                <div class="flex gap-3 mb-5">
                    <input id="new-gider-cat" type="text" placeholder="Gider AdÄ± (Ã¶rn: Elektrik)" class="flex-1 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl font-black text-xs uppercase outline-none border border-transparent focus:border-amber-500">
                    <button onclick="addGiderCat()" class="btn-primary px-6 rounded-xl font-bold text-[11px]">EKLE</button>
                </div>
                <div id="gider-cat-display" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                <h3 class="text-[11px] font-black text-slate-400 mb-4 uppercase tracking-widest">ğŸ‘¤ Cari Rehber</h3>
                <div class="flex gap-3 mb-5">
                    <input id="new-cari-name" type="text" placeholder="Ä°SÄ°M VEYA FÄ°RMA" class="flex-1 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl font-black text-xs uppercase outline-none border border-transparent focus:border-amber-500">
                    <button onclick="saveCariCard()" class="btn-primary px-6 rounded-xl font-bold text-[11px]">KAYDET</button>
                </div>
                <div id="cari-list-display" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm border-amber-200">
                <h3 class="text-[11px] font-black text-amber-500 mb-4 uppercase tracking-widest">ğŸ” GÃ¼venlik AyarlarÄ±</h3>
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-bold text-slate-600">Sistem Kilidini Yeniden Aktif Et</span>
                    <button onclick="lockSystem()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-[10px] font-black">SÄ°STEMÄ° KÄ°LÄ°TLE</button>
                </div>
            </div>
        </div>
    </main>

    <div class="sticky-summary shadow-[0_-10px_30px_rgba(0,0,0,0.1)]">
        <div class="max-w-md mx-auto px-6 py-4">
            <nav class="flex justify-between items-center text-slate-400">
                <button id="btn-kasa" onclick="switchTab('kasa')" class="nav-btn nav-active flex flex-col items-center gap-1 w-1/6 relative">
                    <span class="nav-icon text-2xl">ğŸ“‹</span><span class="text-[8px] font-extrabold uppercase tracking-tighter">Kasa</span>
                </button>
                <button id="btn-cari" onclick="switchTab('cari')" class="nav-btn flex flex-col items-center gap-1 w-1/6 relative">
                    <span class="nav-icon text-2xl">ğŸ‘¥</span><span class="text-[8px] font-extrabold uppercase tracking-tighter">Cari</span>
                </button>
                <button id="btn-gider" onclick="switchTab('gider')" class="nav-btn flex flex-col items-center gap-1 w-1/6 relative">
                    <span class="nav-icon text-2xl">ğŸ’¸</span><span class="text-[8px] font-extrabold uppercase tracking-tighter">Gider</span>
                </button>
                <button id="btn-analiz" onclick="switchTab('analiz')" class="nav-btn flex flex-col items-center gap-1 w-1/6 relative">
                    <span class="nav-icon text-2xl">ğŸ“ˆ</span><span class="text-[8px] font-extrabold uppercase tracking-tighter">Analiz</span>
                </button>
                <button id="btn-gecmis" onclick="switchTab('gecmis')" class="nav-btn flex flex-col items-center gap-1 w-1/6 relative">
                    <span class="nav-icon text-2xl">ğŸ—“ï¸</span><span class="text-[8px] font-extrabold uppercase tracking-tighter">GeÃ§miÅŸ</span>
                </button>
                <button id="btn-settings" onclick="switchTab('settings')" class="nav-btn flex flex-col items-center gap-1 w-1/6 relative">
                    <span class="nav-icon text-2xl">âš™ï¸</span><span class="text-[8px] font-extrabold uppercase tracking-tighter">Ayar</span>
                </button>
            </nav>
        </div>
    </div>

    <script>
        // SÄ°STEM AYARLARI VE DATABASE
        let db = JSON.parse(localStorage.getItem('finans_v21')) || {
            rates: { TRY: 1, USD: 33.5, EUR: 36.5 },
            categories: { "DÃ¶viz": ["TRY", "USD", "EUR"] },
            kasa: [{id: 1, v1:0, v2:0, ana:0, curr:'TRY', note: "", history: []}], 
            alacak: [], borc: [], gider: [],
            cariRehber: [], giderRehber: ["ELEKTRÄ°K", "SU", "KÄ°RA", "TELEFON"], 
            dark: false
        };

        const SYSTEM_PIN = "2233";
        let isAuthenticated = false;
        let authInput = "";

        // PIN FONKSÄ°YONLARI
        function checkAuth() {
            if(!isAuthenticated) {
                document.getElementById('auth-modal').style.display = 'flex';
                return false;
            }
            return true;
        }

        function authPress(num) {
            if(authInput.length < 4) {
                authInput += num;
                let display = "";
                for(let i=0; i<authInput.length; i++) display += "*";
                document.getElementById('auth-display').innerText = display || "****";
                
                if(authInput.length === 4) {
                    if(authInput === SYSTEM_PIN) {
                        isAuthenticated = true;
                        document.getElementById('auth-modal').style.display = 'none';
                        authInput = "";
                        calculate();
                        render();
                    } else {
                        alert("HatalÄ± PIN!");
                        authClear();
                    }
                }
            }
        }

        function authClear() {
            authInput = "";
            document.getElementById('auth-display').innerText = "****";
        }

        function lockSystem() {
            isAuthenticated = false;
            authClear();
            document.getElementById('auth-modal').style.display = 'flex';
        }

        let currentPos = null, posValue = "", isReadOnly = false, archiveData = null, currentNoteObj = null;

        // YENÄ° KASA (OTOMATÄ°K DEVÄ°R VE VERÄ° KAYBI ENGELLEME)
        function save() { 
            if(isReadOnly) return; 
            localStorage.setItem('finans_v21', JSON.stringify(db)); 
            const todayKey = new Date().toLocaleDateString('tr-TR');
            const months = ["OCAK", "SUBAT", "MART", "NISAN", "MAYIS", "HAZIRAN", "TEMMUZ", "AGUSTOS", "EYLUL", "EKIM", "KASIM", "ARALIK"];
            const fileName = `archive_${months[new Date().getMonth()]}_${new Date().getFullYear()}`;
            let monthlyLocalArchive = JSON.parse(localStorage.getItem(fileName)) || {};
            monthlyLocalArchive[todayKey] = JSON.parse(JSON.stringify(db));
            localStorage.setItem(fileName, JSON.stringify(monthlyLocalArchive));
            calculate(); 
            render(); 
        }

        function backupMonth() {
            const months_short = ["OCAK", "SUBAT", "MART", "NISAN", "MAYIS", "HAZIRAN", "TEMMUZ", "AGUSTOS", "EYLUL", "EKIM", "KASIM", "ARALIK"];
            const now = new Date();
            const yearShort = now.getFullYear().toString().slice(-2);
            const customFileName = `${months_short[now.getMonth()]}${yearShort}.json`;
            const storageKey = `archive_${months_short[now.getMonth()]}_${now.getFullYear()}`;
            let fullMonthlyArchive = JSON.parse(localStorage.getItem(storageKey)) || {};
            const todayKey = now.toLocaleDateString('tr-TR');
            fullMonthlyArchive[todayKey] = JSON.parse(JSON.stringify(db));
            const blob = new Blob([JSON.stringify(fullMonthlyArchive, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = customFileName;
            a.click();
        }

        function loadArchive(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (typeof parsed === 'object' && !parsed.kasa) {
                        archiveData = parsed;
                        renderArchivePanel(file.name);
                    } else {
                        archiveData = { "YÃ¼klenen GÃ¼n": parsed };
                        renderArchivePanel(file.name);
                    }
                } catch (err) { alert("Hata: GeÃ§ersiz dosya formatÄ±."); }
            };
            reader.readAsText(file);
        }

        function renderArchivePanel(fileName) {
            isReadOnly = true;
            document.getElementById('archive-panel').classList.remove('hidden');
            document.getElementById('readonly-banner').style.display = 'block';
            document.getElementById('archive-info').innerText = "ğŸ“‚ " + fileName;
            const daySelect = document.getElementById('archive-days-select');
            const compList = document.getElementById('comparison-list');
            daySelect.innerHTML = '<option value="">BÄ°R GÃœN SEÃ‡Ä°N...</option>';
            compList.innerHTML = '';
            Object.keys(archiveData).sort((a,b) => b.split('.').reverse().join('') - a.split('.').reverse().join('')).forEach(day => {
                const option = document.createElement('option');
                option.value = day; option.innerText = day; daySelect.appendChild(option);
                const dayNet = calculateNetForArchive(archiveData[day]);
                const item = document.createElement('div');
                item.className = "flex justify-between items-center p-3 bg-white dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-white/5";
                item.innerHTML = `<span class="text-[9px] font-bold text-slate-500">${day}</span><span class="text-[10px] font-black ${dayNet >= 0 ? 'text-emerald-500' : 'text-rose-500'}">â‚º${dayNet.toLocaleString('tr-TR', {minimumFractionDigits:2})}</span>`;
                compList.appendChild(item);
            });
            document.querySelectorAll('#add-kasa-btn, #add-alacak-btn, #add-borc-btn, #add-gider-btn').forEach(b => b.classList.add('hidden'));
        }

        function loadDayFromArchive() {
            const selectedDay = document.getElementById('archive-days-select').value;
            if(!selectedDay) return;
            db = JSON.parse(JSON.stringify(archiveData[selectedDay]));
            calculate(); render();
        }

        function exitArchiveMode() {
            isReadOnly = false; archiveData = null;
            document.getElementById('archive-panel').classList.add('hidden');
            document.getElementById('readonly-banner').style.display = 'none';
            document.querySelectorAll('#add-kasa-btn, #add-alacak-btn, #add-borc-btn, #add-gider-btn').forEach(b => b.classList.remove('hidden'));
            db = JSON.parse(localStorage.getItem('finans_v21'));
            calculate(); render();
        }

        function calculateNetForArchive(tempDb) {
            const getT = (arr, isK) => {
                let total = 0;
                arr.forEach(i => {
                    const val = isK ? (i.v1 + i.v2 + i.ana) : i.val;
                    total += (val * (tempDb.rates[i.curr] || 1));
                });
                return total;
            };
            return (getT(tempDb.kasa, true) + getT(tempDb.alacak, false)) - (getT(tempDb.borc, false) + getT(tempDb.gider, false));
        }

        function toggleDarkMode() { db.dark = !db.dark; applyDarkMode(); save(); }
        function applyDarkMode() { 
            if(db.dark) document.body.classList.add('dark-mode'); 
            else document.body.classList.remove('dark-mode'); 
        }

        function openPos(type, id, field) { 
            if(isReadOnly) return;
            currentPos = { type, id, field }; posValue = ""; 
            document.getElementById('pos-display').innerText = "0"; 
            document.getElementById('pos-modal').style.display = 'flex'; 
        }
        function posPress(v) { posValue += v.toString(); document.getElementById('pos-display').innerText = posValue; }
        function posClear() { posValue = ""; document.getElementById('pos-display').innerText = "0"; }
        function posConfirm() {
            const val = parseFloat(posValue) || 0;
            let item = db[currentPos.type].find(x => x.id === currentPos.id);
            if(item) {
                if(!item.history) item.history = [];
                const oldVal = item[currentPos.field] || 0;
                if(oldVal !== val) { item.history.push({ date: new Date().toLocaleString('tr-TR'), action: `${currentPos.field.toUpperCase()} DeÄŸiÅŸti: ${oldVal} -> ${val}` }); }
                item[currentPos.field] = val;
            }
            document.getElementById('pos-modal').style.display = 'none';
            save();
        }

        function openNote(type, id) {
            currentNoteObj = { type, id };
            let item = db[type].find(x => x.id === id);
            if(!item) return;
            document.getElementById('note-input').value = item.note || "";
            const histCont = document.getElementById('history-container');
            histCont.innerHTML = (item.history && item.history.length > 0) 
                ? [...item.history].reverse().map(h => `<div class="history-line"><div class="text-[8px] font-black text-amber-500 uppercase">${h.date}</div><div class="text-[10px] font-bold text-slate-600 dark:text-slate-400">${h.action}</div></div>`).join('')
                : `<div class="text-[10px] text-slate-400 italic">HenÃ¼z hareket kaydÄ± yok.</div>`;
            document.getElementById('note-modal').style.display = 'flex';
        }
        function closeNoteModal() { document.getElementById('note-modal').style.display = 'none'; }
        function saveNote() {
            if(isReadOnly) return;
            let item = db[currentNoteObj.type].find(x => x.id === currentNoteObj.id);
            if(item) { item.note = document.getElementById('note-input').value; if(!item.history) item.history = []; item.history.push({ date: new Date().toLocaleString('tr-TR'), action: `Not gÃ¼ncellendi.` }); save(); closeNoteModal(); }
        }

        // ANALÄ°Z VE HESAPLAMA (GÃœNCELLENDÄ°)
        function calculate() {
            if(!isAuthenticated) return;
            
            const usdRate = db.rates.USD || 1;

            const getTotals = (arr, isKasa = false) => {
                let totals = {}; Object.keys(db.rates).forEach(c => totals[c] = 0);
                let tryEq = 0;
                arr.forEach(i => {
                    const val = isKasa ? (i.v1 + i.v2 + i.ana) : i.val;
                    totals[i.curr] = (totals[i.curr] || 0) + val;
                    tryEq += (val * (db.rates[i.curr] || 1));
                });
                return { breakdown: totals, tryEq };
            };

            const dk = getTotals(db.kasa, true), da = getTotals(db.alacak), dborc = getTotals(db.borc), dg = getTotals(db.gider);
            const netMevcut = (dk.tryEq + da.tryEq) - (dborc.tryEq + dg.tryEq);

            // 2x2 Grid GÃ¼ncelleme + USD
            document.getElementById('sum-kasa').innerText = `â‚º${dk.tryEq.toLocaleString('tr-TR')}`;
            document.getElementById('sum-kasa-usd').innerText = `$${(dk.tryEq / usdRate).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            
            document.getElementById('sum-alacak-analiz').innerText = `â‚º${da.tryEq.toLocaleString('tr-TR')}`;
            document.getElementById('sum-alacak-usd').innerText = `$${(da.tryEq / usdRate).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            
            document.getElementById('sum-borc-analiz').innerText = `â‚º${dborc.tryEq.toLocaleString('tr-TR')}`;
            document.getElementById('sum-borc-usd').innerText = `$${(dborc.tryEq / usdRate).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            
            document.getElementById('sum-gider-analiz').innerText = `â‚º${dg.tryEq.toLocaleString('tr-TR')}`;
            document.getElementById('sum-gider-usd').innerText = `$${(dg.tryEq / usdRate).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            
            document.getElementById('sum-net-kazanc').innerText = `â‚º${netMevcut.toLocaleString('tr-TR')}`;
            document.getElementById('sum-net-usd').innerText = `$${(netMevcut / usdRate).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;

            // --- RÄ°SK BARI ---
            const liabilities = dborc.tryEq + dg.tryEq;
            const assets = dk.tryEq + da.tryEq;
            let riskScore = 0;
            let statusText = "HESAPLANIYOR";
            let barColor = "#94a3b8";

            if (assets > 0) {
                if (liabilities === 0) riskScore = 100;
                else {
                    const ratio = assets / liabilities;
                    riskScore = Math.min((ratio / 4) * 100, 100);
                }
            } else {
                riskScore = liabilities > 0 ? 0 : 50; 
            }

            if (riskScore >= 80) { statusText = "GÃœVENLÄ°"; barColor = "#22c55e"; }
            else if (riskScore >= 50) { statusText = "STABÄ°L"; barColor = "#f59e0b"; }
            else if (riskScore >= 25) { statusText = "RÄ°SKLÄ°"; barColor = "#f97316"; }
            else { statusText = "KRÄ°TÄ°K"; barColor = "#ef4444"; }

            const riskBar = document.getElementById('risk-bar');
            riskBar.style.width = `${riskScore}%`;
            riskBar.style.backgroundColor = barColor;
            riskBar.style.boxShadow = `0 0 15px ${barColor}66`;

            document.getElementById('risk-percent').innerText = `${Math.round(riskScore)}%`;
            document.getElementById('risk-percent').style.color = barColor;
            document.getElementById('risk-status').innerText = statusText;
            document.getElementById('risk-status').style.color = barColor;

            // Segmented Bars
            renderSegmentedBar('fin-segmented-bar', 'fin-legend', [
                { label: 'Kasa', val: dk.tryEq, color: '#f59e0b' },
                { label: 'Alacak', val: da.tryEq, color: '#22c55e' },
                { label: 'BorÃ§', val: dborc.tryEq, color: '#ef4444' },
                { label: 'Gider', val: dg.tryEq, color: '#64748b' }
            ]);

            const currData = Object.keys(dk.breakdown).map(c => ({
                label: c,
                val: dk.breakdown[c] * db.rates[c],
                color: c === 'TRY' ? '#6366f1' : (c === 'USD' ? '#22c55e' : '#f59e0b')
            })).filter(x => x.val > 0);
            renderSegmentedBar('curr-segmented-bar', 'curr-legend', currData);

            // Header Update
            const activeTab = document.querySelector('.tab-content.active').id;
            const netValEl = document.getElementById('net-val');
            const netValUsdEl = document.getElementById('net-val-usd');
            let currentDisplayTry = 0;
            if(activeTab === 'kasa-tab') currentDisplayTry = dk.tryEq;
            else if(activeTab === 'cari-tab') currentDisplayTry = (da.tryEq - dborc.tryEq);
            else currentDisplayTry = netMevcut;
            
            netValEl.innerText = `â‚º${currentDisplayTry.toLocaleString()}`;
            netValUsdEl.innerText = `$${(currentDisplayTry / usdRate).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;

            renderEkstre();
        }

        function renderSegmentedBar(barId, legendId, data) {
            const barCont = document.getElementById(barId), legCont = document.getElementById(legendId);
            if(!barCont || !legCont) return;
            barCont.innerHTML = ""; legCont.innerHTML = "";
            const total = data.reduce((s, item) => s + item.val, 0);
            if (total === 0) {
                barCont.innerHTML = `<div class="w-full bg-slate-100 dark:bg-white/5 h-full"></div>`;
                return;
            }
            data.forEach(item => {
                if (item.val > 0) {
                    const percent = (item.val / total) * 100;
                    const seg = document.createElement('div');
                    seg.style.width = `${percent}%`; seg.style.backgroundColor = item.color;
                    seg.className = "h-full transition-all duration-500";
                    barCont.appendChild(seg);
                    legCont.innerHTML += `<div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full" style="background:${item.color}"></div><span class="text-[8px] font-black text-slate-500 uppercase">${item.label} %${Math.round(percent)}</span></div>`;
                }
            });
        }

        function takeCloudSnapshot() {
            const list = document.getElementById('cloud-snapshot-list');
            const now = new Date().toLocaleString('tr-TR');
            const net = document.getElementById('sum-net-kazanc').innerText;
            const entry = document.createElement('div');
            entry.className = "flex justify-between items-center p-3 bg-white dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-white/5 shadow-sm animate-pulse";
            entry.innerHTML = `<div><span class="text-[8px] font-black text-indigo-500 block">SNAPSHOT @ ${now}</span><span class="text-[10px] font-bold text-slate-600 dark:text-slate-300">PortfÃ¶y Durumu Kaydedildi</span></div><span class="text-[10px] font-black text-slate-800 dark:text-white">${net}</span>`;
            setTimeout(() => entry.classList.remove('animate-pulse'), 1000);
            if(list.innerText.includes("baÄŸlantÄ±sÄ± kurulmaya hazÄ±r")) list.innerHTML = "";
            list.prepend(entry);
            alert("Firebase Snapshot: " + now + " itibariyle buluta gÃ¶nderildi (SimÃ¼le edildi).");
        }

        function addCategory() { const n = document.getElementById('new-cat-name').value.toUpperCase().trim(); if (n && !db.categories[n]) { db.categories[n] = []; save(); } }
        function addUnitToCategory() { const cat = document.getElementById('cat-select-for-unit').value, unit = document.getElementById('new-unit-code').value.toUpperCase().trim(); if (cat && unit) { if (!db.categories[cat].includes(unit)) db.categories[cat].push(unit); if (!db.rates[unit]) db.rates[unit] = 1; save(); } }
        function addGiderCat() { const n = document.getElementById('new-gider-cat').value.toUpperCase().trim(); if(n && !db.giderRehber.includes(n)) { db.giderRehber.push(n); save(); } }

        function render() {
            if(!isAuthenticated) return;
            const usdRate = db.rates.USD || 1;

            document.getElementById('kasa-body').innerHTML = db.kasa.map(i => {
                const totalTry = (i.v1+i.v2+i.ana) * (db.rates[i.curr] || 1);
                return `<tr class="hover:bg-slate-50/50 transition-colors"><td class="p-4">${renderCurrSelect('kasa', i.id, i.curr)}</td><td class="p-4 text-right" onclick="openPos('kasa', ${i.id}, 'v1')">${i.v1.toLocaleString()}</td><td class="p-4 text-right" onclick="openPos('kasa', ${i.id}, 'v2')">${i.v2.toLocaleString()}</td><td class="p-4 text-right text-amber-500 font-extrabold" onclick="openPos('kasa', ${i.id}, 'ana')">${i.ana.toLocaleString()}</td><td class="p-4 text-right font-black text-amber-500">${(i.v1+i.v2+i.ana).toLocaleString()}<span class="usd-badge">$${(totalTry/usdRate).toFixed(2)}</span></td><td class="p-4 text-center"><button onclick="openNote('kasa', ${i.id})">ğŸ“</button> <button onclick="remove('kasa', ${i.id})" class="${isReadOnly?'hidden':''}">âœ•</button></td></tr>`
            }).join('');

            ['alacak', 'borc'].forEach(type => { 
                document.getElementById(`${type}-body`).innerHTML = db[type].map(i => {
                    const totalTry = i.val * (db.rates[i.curr] || 1);
                    return `<tr class="transition-colors"><td class="p-5">${renderCariSelect(type, i.id, i.name)}</td><td class="p-5 text-right font-extrabold text-amber-500" onclick="openPos('${type}', ${i.id}, 'val')">${i.val.toLocaleString()}<span class="usd-badge">$${(totalTry/usdRate).toFixed(2)}</span></td><td class="p-5 text-right">${renderCurrSelect(type, i.id, i.curr)}</td><td class="text-center"><button onclick="openNote('${type}', ${i.id})">ğŸ“</button> <button onclick="remove('${type}', ${i.id})" class="${isReadOnly?'hidden':''}">âœ•</button></td></tr>`
                }).join(''); 
            });

            document.getElementById('gider-body').innerHTML = db.gider.map(i => {
                const totalTry = i.val * (db.rates[i.curr] || 1);
                return `<tr class="transition-colors"><td class="p-5"><select onchange="update('gider', ${i.id}, 'name', this.value)" ${isReadOnly?'disabled':''}>${db.giderRehber.map(gn => `<option ${i.name===gn?'selected':''}>${gn}</option>`).join('')}</select></td><td class="p-5 text-right font-extrabold" onclick="openPos('gider', ${i.id}, 'val')">${i.val.toLocaleString()}<span class="usd-badge">$${(totalTry/usdRate).toFixed(2)}</span></td><td class="p-5 text-right">${renderCurrSelect('gider', i.id, i.curr)}</td><td class="text-center"><button onclick="openNote('gider', ${i.id})">ğŸ“</button> <button onclick="remove('gider', ${i.id})" class="${isReadOnly?'hidden':''}">âœ•</button></td></tr>`
            }).join('');

            document.getElementById('cat-select-for-unit').innerHTML = Object.keys(db.categories).map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('rate-management-list').innerHTML = Object.keys(db.categories).map(cat => `<div class="space-y-3"><div class="flex justify-between border-b pb-2"><span class="text-[10px] font-black text-amber-500">${cat}</span></div>${db.categories[cat].map(unit => `<div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-white/5 rounded-2xl"><span>${unit}</span><div class="flex gap-3"><input type="number" step="0.01" ${unit==='TRY'||isReadOnly?'disabled':''} class="text-right font-black w-24 bg-transparent outline-none" value="${db.rates[unit]||1}" onchange="db.rates['${unit}']=parseFloat(this.value); save();"><button onclick="removeUnit('${cat}', '${unit}')" class="${isReadOnly?'hidden':''}">âœ•</button></div></div>`).join('')}</div>`).join('');
            document.getElementById('cari-list-display').innerHTML = db.cariRehber.map(n => `<span class="bg-slate-100 dark:bg-white/5 px-4 py-2 rounded-xl text-[10px] font-bold">${n} <button onclick="deleteCari('${n}')" class="${isReadOnly?'hidden':''}">Ã—</button></span>`).join('');
            const es = document.getElementById('ekstre-select'), curVal = es.value;
            es.innerHTML = `<option value="">ğŸ‘¤ Rehberden SeÃ§...</option>` + db.cariRehber.map(n => `<option value="${n}" ${n===curVal?'selected':''}>${n}</option>`).join('');
        }

        function renderCurrSelect(t, id, curr) { return `<select onchange="update('${t}', ${id}, 'curr', this.value)" ${isReadOnly?'disabled':''}>${Object.keys(db.rates).map(c => `<option ${curr===c?'selected':''}>${c}</option>`).join('')}</select>`; }
        function renderCariSelect(t, id, name) { return `<select onchange="update('${t}', ${id}, 'name', this.value)" ${isReadOnly?'disabled':''}>${db.cariRehber.map(n => `<option ${name===n?'selected':''}>${n}</option>`).join('')}</select>`; }
        function update(t, id, f, v) { if(isReadOnly) return; let item = db[t].find(x => x.id === id); if(item) { item[f] = (f === 'val') ? parseFloat(v) : v; save(); } }
        function addRow(t) { if(isReadOnly) return; const id = Date.now(); if(t === 'kasa') db.kasa.push({id, v1:0, v2:0, ana:0, curr: 'TRY', note: "", history: []}); else db[t].push({id, name: "", val: 0, curr: 'TRY', note: "", history: []}); save(); }
        function remove(t, id) { if(isReadOnly) return; if(confirm('Silsin mi?')) { db[t] = db[t].filter(x => x.id !== id); save(); } }
        function saveCariCard() { const n = document.getElementById('new-cari-name').value.toUpperCase().trim(); if(n && !db.cariRehber.includes(n)) { db.cariRehber.push(n); save(); } }
        
        // --- DÃœZENLENEN EKSTRE FONKSÄ°YONU ---
        function renderEkstre() {
            const name = document.getElementById('ekstre-select').value;
            const usdRate = db.rates.USD || 33.5;
            const resDiv = document.getElementById('ekstre-sonuc');
            const detayBody = document.getElementById('ekstre-detay-body');
            
            // EÄŸer seÃ§im yoksa bÃ¶lÃ¼mÃ¼ gizle
            if(!name || name === "") { 
                resDiv.classList.add('hidden'); 
                if(detayBody) detayBody.innerHTML = "";
                return; 
            }
            
            resDiv.classList.remove('hidden');
            if(detayBody) detayBody.innerHTML = ""; 

            // Verileri Filtrele
            const alacaklar = db.alacak.filter(i => i.name === name);
            const borclar = db.borc.filter(i => i.name === name);
            
            let aTotalTRY = 0;
            let bTotalTRY = 0;

            const allMoves = [
                ...alacaklar.map(i => ({...i, type: 'ALACAK', color: 'text-emerald-500', sign: '+'})),
                ...borclar.map(i => ({...i, type: 'BORÃ‡', color: 'text-rose-500', sign: '-'}))
            ];

            if(allMoves.length === 0) {
                detayBody.innerHTML = `<div class="text-[10px] text-slate-400 italic text-center py-4">Bu kiÅŸiye ait hareket kaydÄ± bulunamadÄ±.</div>`;
            } else {
                allMoves.forEach(m => {
                    const currentRate = db.rates[m.curr] || 1;
                    const tryEquivalent = (m.val * currentRate);
                    
                    if(m.type === 'ALACAK') aTotalTRY += tryEquivalent;
                    else bTotalTRY += tryEquivalent;

                    detayBody.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-white dark:bg-white/5 rounded-xl border border-slate-100 dark:border-white/5 mb-2">
                            <div>
                                <span class="text-[8px] font-black ${m.color} uppercase block">${m.type}</span>
                                <span class="text-[10px] font-bold text-slate-600 dark:text-slate-300">${m.sign}${m.val.toLocaleString('tr-TR')} ${m.curr}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] font-black text-slate-800 dark:text-white">â‚º${tryEquivalent.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                            </div>
                        </div>`;
                });
            }

            const netTRY = aTotalTRY - bTotalTRY;

            // ArayÃ¼z DeÄŸerlerini GÃ¼ncelle
            document.getElementById('ekstre-alacak').innerText = `â‚º${aTotalTRY.toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            document.getElementById('ekstre-borc').innerText = `â‚º${bTotalTRY.toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            document.getElementById('ekstre-net').innerText = `â‚º${Math.abs(netTRY).toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            document.getElementById('ekstre-net-usd').innerText = `$${(Math.abs(netTRY) / usdRate).toLocaleString('en-US', {minimumFractionDigits:2})}`;
            
            const bg = document.getElementById('ekstre-net-bg');
            const icon = document.getElementById('ekstre-icon');
            
            // GÃ¶rsel Durum GÃ¼ncellemesi
            if(netTRY > 0) {
                bg.className = "relative overflow-hidden p-6 rounded-[2rem] shadow-xl bg-gradient-to-br from-emerald-500 to-emerald-700 transition-all duration-500";
                icon.innerText = "ğŸ“ˆ";
            } else if(netTRY < 0) {
                bg.className = "relative overflow-hidden p-6 rounded-[2rem] shadow-xl bg-gradient-to-br from-rose-500 to-rose-700 transition-all duration-500";
                icon.innerText = "ğŸ“‰";
            } else {
                bg.className = "relative overflow-hidden p-6 rounded-[2rem] shadow-xl bg-slate-800 transition-all duration-500";
                icon.innerText = "âš–ï¸";
            }
        }

        function renderHistoryTable() {
            const start = document.getElementById('history-start').value;
            const end = document.getElementById('history-end').value;
            const body = document.getElementById('history-table-body');
            if(!archiveData) {
                body.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-rose-500 font-bold uppercase">Ayarlardan bir dosya aÃ§Ä±n!</td></tr>';
                return;
            }
            const sortedDays = Object.keys(archiveData).sort((a,b) => new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-')));
            let html = "", lastNet = 0;
            sortedDays.forEach((day, index) => {
                const dayDate = new Date(day.split('.').reverse().join('-'));
                if ((start && dayDate < new Date(start)) || (end && dayDate > new Date(end))) { lastNet = calculateNetForArchive(archiveData[day]); return; }
                const dayDb = archiveData[day];
                const currentNet = calculateNetForArchive(dayDb);
                const dailyProfit = index === 0 ? 0 : currentNet - lastNet;
                html += `<tr><td>${day}</td><td class="text-right">â‚º${currentNet.toLocaleString()}</td><td class="text-right">${dayDb.kasa.length}</td><td class="text-right ${dailyProfit>=0?'text-emerald-500':'text-rose-500'}">â‚º${dailyProfit.toLocaleString()}</td><td class="text-[8px] italic">${dayDb.gider.length} Gider</td></tr>`;
                lastNet = currentNet;
            });
            body.innerHTML = html || '<tr><td colspan="5" class="text-center py-10">Veri bulunamadÄ±.</td></tr>';
        }

        function setDateRange(type) {
            const now = new Date();
            let start, end;
            if (type === 'thisMonth') { start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); }
            else if (type === 'lastMonth') { start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); }
            document.getElementById('history-start').value = start.toISOString().split('T')[0];
            document.getElementById('history-end').value = end.toISOString().split('T')[0];
            renderHistoryTable();
        }

        function exportData() { 
            const ws = XLSX.utils.aoa_to_sheet([["PaNeLX Rapor"], ["Kasa ToplamÄ±", calculateNetForArchive(db)]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Finans");
            XLSX.writeFile(wb, `PaNeLX_${new Date().toLocaleDateString()}.xlsx`);
        }

        function switchTab(t) { 
            if(!checkAuth()) return;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); 
            document.getElementById(t + '-tab').classList.add('active'); 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active')); 
            document.getElementById('btn-' + t).classList.add('nav-active'); 
            calculate(); 
        }

        window.onload = () => { applyDarkMode(); checkAuth(); };
    </script>
</body>
</html>