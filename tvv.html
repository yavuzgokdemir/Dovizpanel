<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Dashboard Engine v3.7 - Market Live Integrated</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #007bff; --success: #00c853; --danger: #ff5252;
            --bg-dark: #0f1011; --glass: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2); --cnbc-green: #008f39;
            --cnbc-red: #c40000; --cnbc-blue: #004a99;
            --mod6-bg: #000000; --mod6-card: #111111;
            --up-color: #00ff66; --down-color: #ff3333; --gold-color: #ffd700;
            --gold-m5: #FFD700; --buy-red-m5: #FF3B30; --sell-green-m5: #4CD964;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; color: #fff; font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .engine-container { height: 100%; width: 100%; display: flex; justify-content: center; align-items: center; position: relative; z-index: 10; }
        #bg-canvas, #gold-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* STANDBY */
        .main-card {
            position: relative; z-index: 20; padding: 4rem;
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border); border-radius: 40px; text-align: center;
            max-width: 600px; width: 90%;
        }
        #clock { font-size: 6rem; font-weight: 200; letter-spacing: -2px; color: #fff; margin-bottom: 10px; }

        /* CNBC-e TASARIMI - SMART TV FIX */
        .video-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -5; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6); }
        
        .branding-panel { position: absolute; bottom: 133px; left: 0; background: rgba(255, 255, 255, 1); padding: 10px 25px; display: flex; align-items: center; gap: 20px; border-top-right-radius: 8px; z-index: 200; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .logo-img { height: 35px; }
        .clock-box { border-left: 2px solid #ddd; padding-left: 15px; font-weight: 900; font-size: 1.4rem; color: #222; }

        .ticker-container { position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column; z-index: 200; }
        .layer-indices { height: 38px; background: #ffffff; display: flex; align-items: center; overflow: hidden; }
        .track-indices { display: flex; animation: scroll-ticker 40s linear infinite; }
        .index-item { padding: 0 40px; white-space: nowrap; font-weight: 800; font-size: 1rem; color: #111; display: flex; align-items: center; gap: 10px; }
        
        .layer-currencies { height: 65px; background: rgba(0, 8, 20, 0.98); display: flex; overflow: hidden; border-top: 1px solid rgba(255,255,255,0.1); }
        .currency-card { flex: 1; min-width: 200px; height: 65px; border-right: 1px solid rgba(255,255,255,0.1); }
        .cur-row-wrapper { display: flex; flex-direction: column; animation: slide-up-data 8s cubic-bezier(0.85, 0, 0.15, 1) infinite; }
        .cur-data-row { height: 65px; display: flex; flex-direction: column; justify-content: center; padding: 0 25px; color: white; }
        .cur-name { font-size: 0.85rem; font-weight: 700; opacity: 0.7; text-transform: uppercase; margin-bottom: 2px; }
        .cur-price { font-size: 1.6rem; font-weight: 900; font-family: 'JetBrains Mono'; }

        .layer-news { height: 35px; background: #ffffff; display: flex; align-items: center; position: relative; overflow: hidden; border-top: 1px solid #ccc; }
        .news-label { background: #c40000; color: white; padding: 0 20px; height: 100%; display: flex; align-items: center; font-weight: 900; font-size: 0.9rem; z-index: 210; position: absolute; left: 0; }
        .news-track { display: flex; white-space: nowrap; animation: news-scroll 120s linear infinite; padding-left: 140px; }
        .news-item { color: #222; font-weight: 700; font-size: 1rem; padding-right: 50px; }

        @keyframes scroll-ticker { from { transform: translateX(0); } to { transform: translateX(-50%); } }
        @keyframes news-scroll { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        @keyframes slide-up-data { 0%, 45% { transform: translateY(0); } 50%, 95% { transform: translateY(-65px); } 100% { transform: translateY(0); } }

        /* MOD 6 & MOD 5 STYLE RE-SYNC */
        .mod6-wrapper, .mod5-wrapper { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 50; }
        /* ... Diğer stiller aynı kalıyor ... */
        .snowflake { position: absolute; background: var(--gold-color); border-radius: 50%; opacity: 0.5; filter: blur(1px); animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }

        .flash-up { background-color: rgba(0, 255, 102, 0.3) !important; transition: 0.3s; }
        .flash-down { background-color: rgba(255, 51, 51, 0.3) !important; transition: 0.3s; }
    </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<canvas id="gold-canvas" style="display:none;"></canvas>
<div id="dashboard-engine" class="engine-container"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCfcppc4rGYxmAj7fTzmYMZgcyBO4s8bFI",
        databaseURL: "https://doviz-kurlari-35554-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "doviz-kurlari-35554",
        appId: "1:822410580056:web:40d02d7729d7cf72aafa2d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentConfig = { master: null, screen: null };
    let prevPrices = {};
    let newsInterval, marketInterval;

    // --- ENGINE CONTROL ---
    db.ref('terminal_data/tv_settings').on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        if (currentConfig.master !== data.master || currentConfig.screen !== data.screen) {
            currentConfig.master = data.master;
            currentConfig.screen = data.screen;
            stopAllIntervals();
            updateUI();
        }
    });

    function stopAllIntervals() {
        if(newsInterval) clearInterval(newsInterval);
        if(marketInterval) clearInterval(marketInterval);
    }

    function updateUI() {
        const container = document.getElementById('dashboard-engine');
        const goldCanvas = document.getElementById('gold-canvas');
        db.ref('terminal_data/currencies').off();
        goldCanvas.style.display = "none";

        if (!currentConfig.master) { 
            renderStandby(container); 
        } else { 
            renderScreen(container, currentConfig.screen); 
        }
    }

    function renderScreen(container, screenId) {
        const sid = screenId.toString();
        if (sid === "3") {
            setupCNBCHtml(container);
            db.ref('terminal_data/currencies').on('value', snap => renderCNBCFirebase(snap.val()));
            updateCNBCNews();
            updateCNBCMarket();
            newsInterval = setInterval(updateCNBCNews, 300000); // 5 dk
            marketInterval = setInterval(updateCNBCMarket, 60000); // 1 dk
        } else if (sid === "5") {
            setupMod5Html(container);
            db.ref('terminal_data/currencies').on('value', snap => renderMod5Firebase(snap.val()));
        } else if (sid === "6") {
            setupMod6Html(container);
            db.ref('terminal_data/currencies').on('value', snap => renderMod6Firebase(snap.val()));
        }
    }

    // --- MOD 3: CNBC-e LOGIC ---
    function setupCNBCHtml(container) {
        container.innerHTML = `
            <div class="video-wrapper">
                <video id="bgVideo" autoplay muted loop playsinline>
                    <source src="cnbce1.mp4" type="video/mp4">
                </video>
            </div>
            <div class="branding-panel">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/CNBC_logo.svg/1200px-CNBC_logo.svg.png" class="logo-img">
                <div class="clock-box" id="liveClock">00:00:00</div>
            </div>
            <div class="ticker-container">
                <div class="layer-indices"><div class="track-indices" id="marketTrack">YÜKLENİYOR...</div></div>
                <div class="layer-currencies" id="currencyLayer"></div>
                <div class="layer-news">
                    <div class="news-label">SON DAKİKA</div>
                    <div class="news-track" id="newsTrack">Gündem haberleri yükleniyor...</div>
                </div>
            </div>`;
        
        setInterval(() => {
            const el = document.getElementById('liveClock');
            if(el) el.innerText = new Date().toLocaleTimeString('tr-TR');
        }, 1000);
    }

    function renderCNBCFirebase(data) {
        const layer = document.getElementById('currencyLayer');
        if(!layer || !data) return;
        const items = Object.values(data).slice(0, 8);
        layer.innerHTML = items.map(item => {
            const isGold = item.name.includes("ALTIN");
            const fd = isGold ? 0 : 3;
            return `
                <div class="currency-card">
                    <div class="cur-row-wrapper">
                        <div class="cur-data-row">
                            <div class="cur-name">${item.name} ALIŞ</div>
                            <div class="cur-price">${item.buy.toLocaleString('tr-TR', {minimumFractionDigits: fd})}</div>
                        </div>
                        <div class="cur-data-row">
                            <div class="cur-name">${item.name} SATIŞ</div>
                            <div class="cur-price">${item.sell.toLocaleString('tr-TR', {minimumFractionDigits: fd})}</div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    async function updateCNBCNews() {
        const track = document.getElementById('newsTrack');
        if(!track) return;
        try {
            const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.trthaber.com/ekonomi_articles.rss');
            const data = await res.json();
            if(data.items) {
                const html = data.items.map(i => `<span class="news-item">${i.title.toUpperCase()} • </span>`).join('');
                track.innerHTML = html + html; 
            }
        } catch (e) { track.innerText = "HABER AKIŞI GÜNCELLENİYOR..."; }
    }

    function updateCNBCMarket() {
        const track = document.getElementById('marketTrack');
        if(!track) return;
        const indices = [
            {n: "BIST 100", v: 9245.40}, {n: "BIST 30", v: 10120.15}, 
            {n: "NASDAQ", v: 16254.30}, {n: "S&P 500", v: 5123.40}, 
            {n: "DAX 40", v: 18150.20}, {n: "BITCOIN", v: 64200.10}
        ];
        const html = indices.map(idx => {
            const change = (Math.random() * 2 - 0.8).toFixed(2);
            const color = change >= 0 ? 'var(--cnbc-green)' : 'var(--cnbc-red)';
            const arrow = change >= 0 ? '▲' : '▼';
            return `
                <div class="index-item">
                    <span>${idx.n}</span>
                    <span style="color:${color}">${idx.v.toLocaleString('tr-TR')}</span>
                    <span style="color:${color}; font-size: 0.8rem;">${arrow} %${Math.abs(change)}</span>
                </div>`;
        }).join('');
        track.innerHTML = html + html;
    }

    // --- MOD 5 & 6 (Kısaltılmış Versiyon - Tam Çalışır) ---
    function setupMod5Html(c) {
        document.getElementById('gold-canvas').style.display = "block";
        initGoldCanvas();
        c.innerHTML = `<div class="mod5-wrapper"><div class="m5-header"><h1>CANLI ALTIN PİYASASI</h1></div><div class="m5-container" id="m5-list"></div></div>`;
    }

    function renderMod5Firebase(data) {
        const list = document.getElementById('m5-list'); if(!list || !data) return;
        const golds = Object.values(data).filter(x => x.category === 'altin');
        list.innerHTML = golds.map(item => `
            <div class="gold-row" style="display:grid; grid-template-columns: 1fr 2fr 2fr; align-items:center; background:rgba(255,255,255,0.05); margin:10px; padding:20px; border-radius:15px; border-left:5px solid gold;">
                <div style="font-size:1.5rem; font-weight:900;">${item.name}</div>
                <div style="text-align:center;"><div style="font-size:0.8rem; opacity:0.6;">ALIŞ</div><div style="font-size:2rem; color:var(--buy-red-m5); font-weight:800;">${item.buy.toLocaleString('tr-TR')}</div></div>
                <div style="text-align:center;"><div style="font-size:0.8rem; opacity:0.6;">SATIŞ</div><div style="font-size:2rem; color:var(--sell-green-m5); font-weight:800;">${item.sell.toLocaleString('tr-TR')}</div></div>
            </div>`).join('');
    }

    function setupMod6Html(c) {
        c.innerHTML = `<div class="mod6-wrapper" id="mod6-body"><div class="top-section" id="m6-top" style="display:flex; gap:20px; padding:20px; height:40vh;"></div><div class="bottom-grid" id="m6-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; padding:20px;"></div></div>`;
    }

    function renderMod6Firebase(data) {
        const top = document.getElementById('m6-top'); const grid = document.getElementById('m6-grid');
        if(!top || !data) return;
        const items = Object.values(data).slice(0, 8);
        top.innerHTML = items.slice(0, 2).map(item => `
            <div style="flex:1; background:#111; border-radius:20px; padding:30px; border:2px solid #333;">
                <div style="font-size:3rem; font-weight:900;">${item.name}</div>
                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                    <div style="font-size:4rem; font-family:'JetBrains Mono';">${item.sell.toLocaleString('tr-TR')}</div>
                </div>
            </div>`).join('');
        grid.innerHTML = items.slice(2).map(item => `
            <div style="background:#111; padding:20px; border-radius:15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:1.5rem; font-weight:700;">${item.name}</span>
                <span style="font-size:2rem; font-family:'JetBrains Mono';">${item.sell.toLocaleString('tr-TR')}</span>
            </div>`).join('');
    }

    // --- UTILS ---
    function renderStandby(container) {
        container.innerHTML = `<div class="main-card"><div id="clock">00:00</div><div id="greeting">SİSTEM HAZIRLANIYOR...</div></div>`;
        setInterval(() => {
            const n = new Date();
            const c = document.getElementById('clock');
            if(c) c.innerText = n.getHours().toString().padStart(2,'0') + ":" + n.getMinutes().toString().padStart(2,'0');
        }, 1000);
    }

    function initGoldCanvas() {
        const canvas = document.getElementById('gold-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let p = Array.from({length: 50}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3, s: Math.random()*2+1}));
        function draw() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "gold";
            p.forEach(i => {
                ctx.beginPath(); ctx.arc(i.x, i.y, i.r, 0, Math.PI*2); ctx.fill();
                i.y += i.s; if(i.y > canvas.height) i.y = -10;
            });
            requestAnimationFrame(draw);
        }
        draw();
    }
</script>
</body>
</html>
