<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Dashboard Engine v3.6 - Multi-Mode</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600;900&family=Montserrat:wght@700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

<style>
:root {
    --glass: rgba(255,255,255,0.1);
    --border: rgba(255,255,255,0.2);
    --eko-red: #c61118; --eko-green: #118c4f; --eko-turkuaz: #0087b3; --eko-dark: #121516;
    --eko-gray: #2d2f30;
}

* { box-sizing:border-box; }
body, html { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; color:#fff; font-family:'Inter', sans-serif; }

/* CANVAS & VIDEO BASE */
#bg-canvas { position:absolute; inset:0; z-index:0; display:none; }
.video-container { position:fixed; inset:0; z-index:0; display:none; }
video { width:100%; height:100%; object-fit:cover; }
.engine-container { width:100%; height:100%; position:relative; z-index:2; }

/* ===== MOD 0: PREMIUM STANDBY ===== */
.standby-wrapper { width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:#0f172a; }
.main-card { padding:4rem; background:var(--glass); backdrop-filter:blur(25px); border:1px solid var(--border); border-radius:40px; text-align:center; max-width:600px; width:90%; animation:fadeIn 1.5s ease; }
#sClock { font-size:6rem; font-weight:200; letter-spacing:-2px; background:linear-gradient(to bottom,#fff,#94a3b8); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
#greeting { font-size:1.8rem; margin-top:10px; opacity:0.9; height:2rem; transition:opacity .8s; }
.divider { width:60px; height:1px; background:rgba(255,255,255,.3); margin:2rem auto; }
.weather { display:flex; justify-content:center; gap:15px; align-items:center; font-size:1.2rem; }
.temp { background:#fff; color:#0f172a; padding:5px 15px; border-radius:20px; font-weight:600; }

/* ===== MOD 1: EKOTÜRK TASARIMI ===== */
.eko-layout { width:100%; height:100%; position:relative; font-family:'Montserrat', sans-serif; }
.eko-layout .layer-headline { position:absolute; bottom:134px; width:100%; height:60px; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px); display:flex; align-items:center; padding-left:30px; border-top:2px solid rgba(255,255,255,0.1); }
.eko-layout .layer-stocks { position:absolute; bottom:102px; width:100%; height:32px; background:var(--eko-gray); display:flex; align-items:center; overflow:hidden; border-bottom:1px solid #444; }
.eko-layout .layer-currency { position:absolute; bottom:32px; width:calc(100% - 140px); height:70px; background:var(--eko-dark); display:flex; }
.eko-layout .side-panel { position:absolute; right:0; bottom:32px; width:140px; height:132px; background:#004d66; display:flex; flex-direction:column; align-items:center; justify-content:space-around; }
.currency-box { flex:1; border-right:1px solid #333; padding:10px; display:flex; flex-direction:column; }
.curr-name { font-size:0.75rem; color:#aaa; font-weight:bold; margin-bottom:5px; }
.flip-container { height:35px; overflow:hidden; position:relative; }
.flip-inner { position:absolute; width:100%; transition:transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
.flip-row { height:35px; display:flex; align-items:center; color:white; font-size:1.5rem; font-weight:700; }
.marquee-track { display:flex; animation:scroll-left 40s linear infinite; white-space:nowrap; }
@keyframes scroll-left { from { transform:translateX(0); } to { transform:translateX(-50%); } }
@keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
.up-trend { background:rgba(17, 140, 79, 0.2); }
.down-trend { background:rgba(198, 17, 24, 0.2); }
</style>
</head>

<body>
<div class="video-container" id="vCont"><video id="mainVid" autoplay muted loop playsinline><source src="Video1.mp4" type="video/mp4"></video></div>
<canvas id="bg-canvas"></canvas>
<div id="dashboard-engine" class="engine-container"></div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
    apiKey:"AIzaSyCfcppc4rGYxmAj7fTzmYMZgcyBO4s8bFI",
    databaseURL:"https://doviz-kurlari-35554-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"doviz-kurlari-35554",
    appId:"1:822410580056:web:40d02d7729d7cf72aafa2d"
});
const db=firebase.database();

/* ===== ENGINE STATE ===== */
let currentConfig={master:null,screen:null};
let currentCurrencies=[];
let intervals={clock:null,greet:null};
let animId=null, flipState=false, greetingState=0, timeMessage="";

/* ===== DATABASE LISTENERS ===== */
db.ref('terminal_data').on('value', snap => {
    const d = snap.val(); if(!d) return;
    const m = d.tv_settings?.master || false;
    const s = String(d.tv_settings?.screen || "0");
    currentCurrencies = d.currencies ? Object.values(d.currencies) : [];

    if(m !== currentConfig.master || s !== currentConfig.screen) {
        currentConfig = {master:m, screen:s};
        updateUI();
    } else if(currentConfig.screen === "1") {
        renderMod1Content(); // Veri güncellendiğinde sadece Mod 1 içeriğini yenile
    }
});

function clearAll() {
    Object.values(intervals).forEach(i => { if(i) clearInterval(i); });
    if(animId) cancelAnimationFrame(animId);
}

/* ===== UI SWITCH ===== */
function updateUI() {
    clearAll();
    const engine = document.getElementById("dashboard-engine");
    const canvas = document.getElementById("bg-canvas");
    const vCont = document.getElementById("vCont");
    const video = document.getElementById("mainVid");

    engine.innerHTML = "";
    canvas.style.display = "none";
    vCont.style.display = "none";

    if(!currentConfig.master) {
        renderStandby(engine);
    } else if(currentConfig.screen === "1") {
        vCont.style.display = "block";
        video.play().catch(e=>console.log("Play blocked"));
        renderMod1(engine);
    } else if(currentConfig.screen === "3") {
        vCont.style.display = "block";
        video.play().catch(e=>console.log("Play blocked"));
        engine.innerHTML = `<h1 style="padding:50px">MOD 3 - SADE VIDEO</h1>`;
    }
}

/* ===== MOD 0: STANDBY ===== */
function renderStandby(container){
    document.getElementById("bg-canvas").style.display="block";
    container.innerHTML=`<div class="standby-wrapper"><div class="main-card"><div id="sClock">00:00</div><div id="greeting"></div><div class="divider"></div><div class="weather"><span>İSTANBUL</span><span class="temp">18°C</span><span>Az Bulutlu</span></div></div></div>`;
    updateClock();
    intervals.clock=setInterval(updateClock,1000);
    intervals.greet=setInterval(toggleGreeting,5000);
    initParticles();
}

/* ===== MOD 1: EKOTÜRK (ENJECTE) ===== */
function renderMod1(container) {
    container.className = "engine-container eko-layout";
    renderMod1Content();
    if(!intervals.flip) {
        intervals.flip = setInterval(() => {
            flipState = !flipState;
            document.querySelectorAll('.flip-inner').forEach(el => {
                el.style.transform = flipState ? 'translateY(-35px)' : '0px';
            });
        }, 4000);
    }
    intervals.clock = setInterval(updateClock, 1000);
}

function renderMod1Content() {
    const container = document.getElementById("dashboard-engine");
    if(currentConfig.screen !== "1" || !currentConfig.master) return;
    
    container.innerHTML = `
        <div class="side-panel">
            <div style="font-weight:900; color:white; font-size:1.2rem; text-align:center">EKOTÜRK</div>
            <div id="liveTime" style="font-size:1.5rem; font-weight:bold">${new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})}</div>
        </div>
        <div class="layer-headline"><div style="color:white; font-size:1.8rem;">PIYASALARDA VERI AKIŞI TAKİP EDİLİYOR</div></div>
        <div class="layer-stocks"><div class="marquee-track">${generateStockTicker()}</div></div>
        <div class="layer-currency">${generateFlipGrid()}</div>
        <div style="position:absolute; bottom:0; width:100%; height:32px; background:var(--eko-turkuaz); display:flex; align-items:center;">
            <marquee style="color:white; font-weight:bold;">TCMB Para Politikası Kararları Takip Ediliyor... Döviz Kurlarında Hareketlilik Sürüyor...</marquee>
        </div>
    `;
}

function generateFlipGrid() {
    return currentCurrencies.slice(0, 5).map(item => `
        <div class="currency-box ${Math.random() > 0.5 ? 'up-trend' : 'down-trend'}">
            <div class="curr-name">${item.name}</div>
            <div class="flip-container">
                <div class="flip-inner" style="transform: translateY(${flipState ? '-35px' : '0px'})">
                    <div class="flip-row"><span>${parseFloat(item.buy).toFixed(4)}</span></div>
                    <div class="flip-row"><span>${parseFloat(item.sell).toFixed(4)}</span></div>
                </div>
            </div>
        </div>
    `).join('');
}

function generateStockTicker() {
    return [...currentCurrencies, ...currentCurrencies].map(s => `
        <div style="padding:0 25px; font-weight:bold; border-right:1px solid #555;">
            ${s.name} <span style="color:white">${parseFloat(s.sell).toFixed(2)}</span> <span style="color:#00ff88">▲</span>
        </div>
    `).join('');
}

/* ===== UTILS ===== */
function updateClock(){
    const n=new Date(); const h=n.getHours(); const m=n.getMinutes().toString().padStart(2,'0');
    const clockEl = document.getElementById("sClock") || document.getElementById("liveTime");
    if(clockEl) clockEl.innerText=`${h}:${m}`;
    
    if(h>=5&&h<12)timeMessage="GÜNAYDIN";
    else if(h<18)timeMessage="İYİ GÜNLER";
    else if(h<23)timeMessage="İYİ AKŞAMLAR";
    else timeMessage="İYİ GECELER";
}

function toggleGreeting(){
    const g=document.getElementById("greeting"); if(!g) return;
    g.style.opacity=0;
    setTimeout(()=>{
        g.innerText=greetingState?timeMessage:"HOŞ GELDİNİZ";
        greetingState=!greetingState; g.style.opacity=1;
    },800);
}

function initParticles(){
    const c=document.getElementById("bg-canvas"); const ctx=c.getContext("2d");
    c.width=innerWidth; c.height=innerHeight; let p=[];
    for(let i=0;i<100;i++)p.push({x:Math.random()*c.width,y:Math.random()*c.height,s:Math.random()*2,vx:Math.random()*.4-.2,vy:Math.random()*.4-.2});
    (function a(){
        if(currentConfig.master)return; ctx.clearRect(0,0,c.width,c.height);
        p.forEach(o=>{ o.x+=o.vx;o.y+=o.vy; if(o.x<0)o.x=c.width; if(o.y<0)o.y=c.height; if(o.x>c.width)o.x=0; if(o.y>c.height)o.y=0; ctx.fillStyle="rgba(255,255,255,.4)"; ctx.beginPath(); ctx.arc(o.x,o.y,o.s,0,Math.PI*2); ctx.fill(); });
        animId=requestAnimationFrame(a);
    })();
}
</script>
</body>
</html>
